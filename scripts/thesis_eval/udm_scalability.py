#!/usr/bin/env python3
import numpy as np
import matplotlib
matplotlib.use("pgf")
matplotlib.rcParams.update({
    "pgf.texsystem": "pdflatex",
    "text.usetex": True,
    "pgf.rcfonts": False,
    "font.family": "serif",
    "font.serif": ["Palatino"],
    "axes.labelsize": 11,
    "font.size": 11,
    "legend.fontsize": 10,
    "xtick.labelsize": 10,
    "ytick.labelsize": 10,
})

import matplotlib.pyplot as plt

# ============================================================
# DATA STRUCTURE (UDM → UE → samples)
# Each sample = (Total, R1, R2, R3)
# ============================================================

data = {
    1: {  # 1 UDM
        128: [
            (5.2503824609375e+06, 569916.7578125, 1.5242210703125e+06, 3.1562446328125e+06),
            (3.8652342734375e+06, 450921.6875, 718158.421875, 2.6961541640625e+06),
            (3.468628703125e+06, 432805.71875, 680103.640625, 2.35571934375e+06),
            (3.4615759609375e+06, 320500.6015625, 486410.765625, 2.65466459375e+06),
            (3.863208234375e+06, 605596.4296875, 701993.4765625, 2.555618328125e+06),
        ],
        256: [
            (9.27366191796875e+06, 1.75529765234375e+06, 1.4482003203125e+06, 6.0701639453125e+06),
            (8.2919435078125e+06, 785218.25390625, 1.21200106640625e+06, 6.2947241875e+06),
            (6.5426269921875e+06, 1.2161788125e+06, 1.05444756640625e+06, 4.27200061328125e+06),
            (8.7649936875e+06, 1.06073179296875e+06, 1.3705592890625e+06, 6.33370260546875e+06),
            (9.3484519375e+06, 1.48283752734375e+06, 1.31519537109375e+06, 6.5504190390625e+06),
        ],
        384: [
            (1.3724509981770834e+07, 2.0211388958333333e+06, 3.2868395104166665e+06, 8.416531575520834e+06),
            (1.2935155994791666e+07, 1.882636484375e+06, 2.250530140625e+06, 8.801989369791666e+06),
            (1.6801223572916668e+07, 2.05364240625e+06, 3.8775190625e+06, 1.0870062104166666e+07),
            (1.43548992890625e+07, 2.202056328125e+06, 3.7362242395833335e+06, 8.416618721354166e+06),
            (1.4589702463541666e+07, 1.6899773489583333e+06, 2.0369366796875e+06, 1.0862788434895834e+07),
        ],
        512: [
            (1.7394166189453125e+07, 2.883514048828125e+06, 2.93249421875e+06, 1.1578157921875e+07),
            (1.8055417580078125e+07, 3.72035850390625e+06, 3.894236673828125e+06, 1.044082240234375e+07),
            (1.9515586943359375e+07, 2.977053615234375e+06, 4.692207205078125e+06, 1.1846326123046875e+07),
            (2.0531695642578125e+07, 3.338183587890625e+06, 3.682366439453125e+06, 1.3511145615234375e+07),
            (1.8893641529296875e+07, 2.912384595703125e+06, 3.759592849609375e+06, 1.2221664083984375e+07),
        ],
    },
    2: {  # 2 UDM
        128: [
            (3.58003946875e+06, 604466.5234375, 687176.5078125, 2.2883964375e+06),
            (3.3779555433070865e+06, 489777.7165354331, 686950.1181102362, 2.2012277086614175e+06),
            (2.735197748031496e+06, 412788.6535433071, 562974.0236220473, 1.7594350708661417e+06),
            (3.109113796875e+06, 495926.8671875, 679646.3046875, 1.933540625e+06),
            (2.9478783385826773e+06, 448724.83464566927, 782182.0787401575, 1.7169714251968504e+06),
        ],
        256: [
            (7.2281937450980395e+06, 795475.8470588236, 1.2067366196078432e+06, 5.225981278431373e+06),
            (6.56717585546875e+06, 1.06545576171875e+06, 1.813305390625e+06, 3.688414703125e+06),
            (7.34190280078125e+06, 1.92510055859375e+06, 1.679485359375e+06, 3.7373168828125e+06),
            (7.187227937254902e+06, 1.0300930901960784e+06, 1.4672224588235293e+06, 4.689912388235294e+06),
            (7.744964181102362e+06, 1.5707779212598426e+06, 2.4113926338582677e+06, 3.762793625984252e+06),
        ],
        384: [
            (9.853972559895834e+06, 1.3809622161458333e+06, 2.4754367395833335e+06, 5.997573604166667e+06),
            (1.0851334119791666e+07, 1.7229273645833333e+06, 2.5671946432291665e+06, 6.561212111979167e+06),
            (1.2925637744791666e+07, 2.2401592109375e+06, 3.34724390625e+06, 7.338234627604167e+06),
            (1.10661398046875e+07, 1.5719287708333333e+06, 2.4171415182291665e+06, 7.077069515625e+06),
            (1.0187479520833334e+07, 1.6074795989583333e+06, 2.2584739739583335e+06, 6.321525947916667e+06),
        ],
        512: [
            (1.466347631640625e+07, 2.175991962890625e+06, 3.1807746328125e+06, 9.306709720703125e+06),
            (1.4646902708984375e+07, 2.043738322265625e+06, 3.219582681640625e+06, 9.383581705078125e+06),
            (1.5455512591796875e+07, 3.210339935546875e+06, 3.491532728515625e+06, 8.753639927734375e+06),
            (1.49035297109375e+07, 2.207466205078125e+06, 3.206929921875e+06, 9.489133583984375e+06),
            (1.487571684765625e+07, 2.087670064453125e+06, 2.917991482421875e+06, 9.87005530078125e+06),
        ],
    },
    4: {  # 4 UDM
        128: [
            (3.1860926640625e+06, 507266.1171875, 568414.984375, 2.1104115625e+06),
            (1.9386006484375e+06, 342489.1171875, 527183.6484375, 1.0689278828125e+06),
            (2.6462280390625e+06, 475081.8046875, 609015.0234375, 1.5621312109375e+06),
            (2.8750672578125e+06, 461197.640625, 871176.6328125, 1.542692984375e+06),
            (2.0751736484375e+06, 388923.59375, 539516.3046875, 1.14673375e+06),
        ],
        256: [
            (6.3309042734375e+06, 1.465588859375e+06, 1.63232178515625e+06, 3.23299362890625e+06),
            (6.320061239215686e+06, 1.0220613843137255e+06, 1.3821258784313726e+06, 3.9158739764705882e+06),
            (6.061845545098039e+06, 1.047129768627451e+06, 1.3747978784313726e+06, 3.6399178980392157e+06),
            (6.6874389609375e+06, 943137.19140625, 1.227737515625e+06, 4.51656425390625e+06),
            (7.0020937421875e+06, 1.10300316015625e+06, 2.3078875625e+06, 3.59120301953125e+06),
        ],
        384: [
            (8.614287208333334e+06, 1.5315903489583333e+06, 2.0551916614583333e+06, 5.027505197916667e+06),
            (9.198459028645834e+06, 1.5667153697916667e+06, 2.6160920182291665e+06, 5.015651640625e+06),
            (9.942402638020834e+06, 1.7314161640625e+06, 2.304661109375e+06, 5.906325364583333e+06),
            (1.0846611098958334e+07, 2.6868134895833335e+06, 3.02342971875e+06, 5.136367890625e+06),
            (1.0183670752604166e+07, 2.6083477265625e+06, 2.3189808671875e+06, 5.256342158854167e+06),
        ],
        512: [
            (1.3946001127201566e+07, 2.1815564637964773e+06, 2.8860898160469667e+06, 8.87835484735812e+06),
            (1.3673980353515625e+07, 2.322420337890625e+06, 3.34842174609375e+06, 8.00313826953125e+06),
            (1.4060925220703125e+07, 2.065231818359375e+06, 3.437410748046875e+06, 8.558282654296875e+06),
            (1.2397015529296875e+07, 1.860701966796875e+06, 2.473173625e+06, 8.0631399375e+06),
            (1.3283869896281801e+07, 1.833870878669276e+06, 2.664122700587084e+06, 8.78587631702544e+06),
        ],
    },
}

# ============================================================
# PLOTTING
# ============================================================

def main():
    udm_list = sorted(data.keys())
    ue_counts = sorted(list(data[1].keys()))

    # Figure with 4 subplots
    fig, axs = plt.subplots(2, 2, figsize=(8, 8))
    axs = axs.flatten()

    titles = [
        "Total Registration Time",
        "NAS Reg. Req. → NAS Auth. Req.",
        "NAS Auth. Res. → NAS SecModeCmd",
        "NAS SecModeComplete → IniCtxSetup Req."
    ]

    metric_index = [0, 1, 2, 3]  # which value in the tuple

    for plot_idx in range(4):
        ax = axs[plot_idx]
        mi = metric_index[plot_idx]

        for udm in udm_list:
            scatter_x = []
            scatter_y = []
            avg_y = []

            for ue in ue_counts:
                samples = data[udm][ue]

                vals = np.array([row[mi] for row in samples]) / 1e6
                avg = np.average(vals)
                avg_y.append(avg)

                scatter_x.extend([ue] * len(vals))
                scatter_y.extend(vals)

            # scatter
            ax.scatter(scatter_x, scatter_y, s=2.5, alpha=0.70, label=f"{udm} UDM(s)")

            # average line
            ax.plot(ue_counts, avg_y, linewidth=0.8)

        ax.set_title(titles[plot_idx])
        ax.set_xlabel("User Equipment Count")
        ax.set_ylabel("Duration (s)")
        ax.grid(True, linestyle='--', linewidth=0.4, alpha=0.6)
        ax.legend(fontsize=7)

    plt.tight_layout()
    plt.savefig("udm_scalability.png", dpi=300)

    print("Generated: udm_scalability.png")

if __name__ == "__main__":
    main()